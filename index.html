<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mi Cuadro</title>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300&family=Lato:wght@300;400&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --frame-black: #1a1a1a;
      --mat-white:   #f5f5f3;
      --bg:          #d8d9d6;
      --accent:      #b89c7a;
      --text-dark:   #2a2a2a;
    }

    html, body {
      width: 100%; height: 100%;
      background: var(--bg);
      overflow: hidden;
      font-family: 'Lato', sans-serif;
    }

    /* â•â•â•â•â•â•â•â• PANTALLA INICIAL â•â•â•â•â•â•â•â• */
    #tap-screen {
      position: fixed; inset: 0;
      background: #000;
      z-index: 2000;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 20px;
      cursor: pointer;
      transition: opacity 0.5s;
    }
    #tap-screen.hide { opacity: 0; pointer-events: none; }
    .tap-icon { font-size: 56px; animation: tapPulse 1.5s ease-in-out infinite; }
    @keyframes tapPulse {
      0%,100% { transform: scale(1);    opacity: .8; }
      50%     { transform: scale(1.15); opacity: 1;  }
    }
    .tap-label {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(18px, 5vw, 28px);
      font-style: italic; color: #fff;
      letter-spacing: .08em; opacity: .85;
    }
    .tap-sub {
      font-size: 12px; letter-spacing: .18em;
      text-transform: uppercase; color: #888;
    }

    /* â•â•â•â•â•â•â•â• CORTINA â•â•â•â•â•â•â•â• */
    #curtain-top, #curtain-bot {
      position: fixed; left: 0; right: 0;
      background: #000; z-index: 1000;
      pointer-events: none; will-change: transform;
    }
    #curtain-top { top: 0;    height: 50%; transform-origin: top    center; }
    #curtain-bot { bottom: 0; height: 50%; transform-origin: bottom center; }
    #curtain-top.open { animation: slideUp   1.5s cubic-bezier(0.76,0,0.24,1) forwards; }
    #curtain-bot.open { animation: slideDown 1.5s cubic-bezier(0.76,0,0.24,1) forwards; }
    @keyframes slideUp   { to { transform: scaleY(0); } }
    @keyframes slideDown { to { transform: scaleY(0); } }

    /* â•â•â•â•â•â•â•â• CONFETI â•â•â•â•â•â•â•â• */
    #party-canvas {
      position: fixed; inset: 0;
      z-index: 500; pointer-events: none;
      opacity: 0; transition: opacity 0.4s;
    }
    #party-canvas.active { opacity: 1; }

    /* â•â•â•â•â•â•â•â• TROMPETAS â•â•â•â•â•â•â•â• */
    .horn {
      position: fixed; z-index: 600; pointer-events: none;
      opacity: 0;
      font-size: clamp(34px, 6.5vw, 66px);
      filter: drop-shadow(0 4px 14px rgba(0,0,0,.25));
      animation: hornIn 0.55s ease forwards, hornFloat 2.2s 0.55s ease-in-out infinite alternate;
    }
    @keyframes hornIn {
      0%   { opacity: 0; transform: scale(0)    rotate(var(--rot)); }
      65%  {             transform: scale(1.25) rotate(var(--rot)); }
      100% { opacity: 1; transform: scale(1)    rotate(var(--rot)); }
    }
    @keyframes hornFloat {
      from { transform: scale(1) rotate(var(--rot)) translateY(0);    }
      to   { transform: scale(1) rotate(var(--rot)) translateY(-16px);}
    }
    .horn.bye { animation: hornOut 0.55s ease forwards !important; }
    @keyframes hornOut {
      to { opacity: 0; transform: scale(0.2) rotate(var(--rot)) translateY(-50px); }
    }

    /* â•â•â•â•â•â•â•â• ESCENA â•â•â•â•â•â•â•â• */
    #scene {
      width: 100vw; height: 100vh;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; transform: scale(0.15);
    }
    #scene.zoom-in {
      animation: zoomIn 2.6s cubic-bezier(0.16,1,0.3,1) forwards;
    }
    @keyframes zoomIn {
      0%  { transform: scale(0.15); opacity: 0; }
      22% { opacity: 1; }
      100%{ transform: scale(1);    opacity: 1; }
    }

    /* â•â•â•â•â•â•â•â• MARCO â•â•â•â•â•â•â•â• */
    .frame-outer {
      background: var(--frame-black);
      padding: 18px;
      box-shadow:
        0 4px 6px   rgba(0,0,0,.18),
        0 12px 30px rgba(0,0,0,.28),
        0 30px 60px rgba(0,0,0,.20);
      width: min(92vw, 480px);
      max-height: 96vh;
      display: flex; flex-direction: column;
    }

    /* En pantalla: scroll interno para que el cuadro no se salga del viewport */
    .frame-mat {
      background: var(--mat-white);
      padding: 28px 24px 24px;
      display: flex; flex-direction: column;
      align-items: center; gap: 18px;
      overflow-y: auto;
      max-height: calc(96vh - 36px);
    }

    /* Mientras se captura, eliminamos los lÃ­mites con esta clase */
    .frame-outer.capturing        { max-height: none !important; }
    .frame-outer.capturing
      .frame-mat                  { max-height: none !important; overflow: visible !important; }

    /* â•â•â•â•â•â•â•â• FOTO fija â•â•â•â•â•â•â•â• */
    .photo-fixed {
      width: 100%;
      height: 0;
      padding-bottom: 60%; /* cuadrada 1:1 â€” cambiÃ¡ este valor para otros formatos:
                                75%      = horizontal 4:3
                                56.25%   = panorÃ¡mica 16:9
                                133.33%  = vertical 3:4
                                177.77%  = vertical 9:16  */
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
    }
    .photo-fixed img {
      position: absolute;
      inset: 0;
      width: 100%; height: 100%;
      object-fit: cover; display: block;
    }

    /* â•â•â•â•â•â•â•â• TEXTO fijo â•â•â•â•â•â•â•â• */
    .center-text {
      font-family: 'Cormorant Garamond', serif;
      font-size: clamp(14px, 3.8vw, 21px);
      font-weight: 300; font-style: italic;
      color: var(--text-dark);
      text-align: center; line-height: 1.6;
      letter-spacing: .02em;
      width: 100%;
    }

    .divider {
      width: 60px; height: 1px;
      flex-shrink: 0;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    /* â•â•â•â•â•â•â•â• FORMULARIO â•â•â•â•â•â•â•â• */
    .form-area { width: 100%; display: flex; flex-direction: column; gap: 14px; }

    .field label {
      display: block; font-size: 10px;
      letter-spacing: .12em; text-transform: uppercase;
      color: #999; margin-bottom: 5px;
    }
    .field input {
      width: 100%; border: none;
      border-bottom: 1px solid #ccc;
      background: transparent;
      font-family: 'Lato', sans-serif;
      font-size: 14px; color: var(--text-dark);
      padding: 6px 2px; outline: none;
      transition: border-color .3s;
    }
    .field input:focus { border-bottom-color: var(--accent); }

    /* Textarea del mensaje:
       - En pantalla: altura limitada con scroll
       - Al capturar: se expande automÃ¡ticamente (ver clase .capturing arriba) */
    .field textarea {
      width: 100%; border: none;
      border-bottom: 1px solid #ccc;
      background: transparent;
      font-family: 'Lato', sans-serif;
      font-size: 14px; color: var(--text-dark);
      padding: 6px 2px; outline: none;
      transition: border-color .3s;
      resize: none;
      /* Altura fija en pantalla â€” muestra unas 3 lÃ­neas */
      min-height: 60px;
      max-height: 90px;
      overflow-y: auto;
    }
    .field textarea:focus { border-bottom-color: var(--accent); }

    /* Al capturar, el textarea tambiÃ©n se expande */
    .frame-outer.capturing .field textarea {
      max-height: none !important;
      overflow: visible !important;
      height: auto !important;
    }

    /* Nombre en bold al exportar */
    #name-display {
      display: none;
      width: 100%;
      font-family: 'Lato', sans-serif;
      font-size: 14px;
      font-weight: bold;
      color: var(--text-dark);
      padding: 6px 2px;
      border-bottom: 1px solid #ccc;
    }
    .frame-outer.capturing #nameInput   { display: none !important; }
    .frame-outer.capturing #name-display { display: block !important; }

    .btn-send {
      align-self: center; margin-top: 4px;
      background: var(--frame-black); color: #f5f5f3;
      border: none; padding: 10px 32px;
      font-family: 'Lato', sans-serif; font-size: 11px;
      letter-spacing: .15em; text-transform: uppercase;
      cursor: pointer; transition: background .3s, transform .15s;
    }
    .btn-send:hover  { background: #333; transform: translateY(-1px); }
    .btn-send:active { transform: translateY(0); }
    .btn-send:disabled { opacity: .5; cursor: default; }

    #status {
      font-size: 12px; text-align: center;
      color: var(--accent); min-height: 16px; letter-spacing: .04em;
    }

    .frame-mat::-webkit-scrollbar { width: 4px; }
    .frame-mat::-webkit-scrollbar-thumb { background: #ccc; border-radius: 2px; }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     âœï¸  CONFIGURACIÃ“N â€” solo editÃ¡ esto
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
  // ğŸ“¸ Nombre del archivo de tu foto (debe estar en la misma carpeta que index.html)
  const FOTO = 'foto.jpg';

  // ğŸ’¬ Texto fijo que aparece debajo de la foto
  const TEXTO = 'Hoy celebramos algo muy especial\ny quiero que seas parte de este momento.';

  // ğŸµ Nombre del archivo de audio
  const AUDIO = 'intro.mp3';

  // ğŸ”— URL de tu Google Apps Script
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzRmd5-R9WvvrEKS2Vi0apgFUWOAGndDyEpHA_rbY55HFCeZCDK4llSXElovBCpqsKv-A/exec';

  // â±ï¸ DuraciÃ³n del audio en milisegundos
  const TOTAL_MS = 6000;
</script>
<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- PANTALLA INICIAL -->
<div id="tap-screen" onclick="startShow()">
  <div class="tap-icon">ğŸ‰</div>
  <div class="tap-label">TocÃ¡ para descubrir</div>
  <div class="tap-sub">toca cualquier parte</div>
</div>

<!-- CORTINA -->
<div id="curtain-top"></div>
<div id="curtain-bot"></div>

<!-- CONFETI -->
<canvas id="party-canvas"></canvas>

<!-- ESCENA -->
<div id="scene">
  <div class="frame-outer" id="frame-outer">
    <div class="frame-mat">

      <div class="photo-fixed">
        <img id="main-photo" alt="foto" />
      </div>

      <p class="center-text" id="main-text"></p>

      <div class="divider"></div>

      <div class="form-area">
        <div class="field">
          <label>Nombre</label>
          <input type="text" id="nameInput" placeholder="Tu nombre..." />
          <div id="name-display"></div>
        </div>
        <div class="field">
          <label>Te invito a dejarme un lindo mensaje</label>
          <textarea id="msgInput" placeholder="Tu mensaje..."></textarea>
        </div>
      </div>

      <button class="btn-send" id="sendBtn" onclick="submitForm()">Enviar</button>
      <div id="status"></div>

    </div>
  </div>
</div>

<audio id="intro-audio" preload="auto"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
<script>
/* â”€â”€ Inyectar config â”€â”€ */
document.getElementById('main-photo').src = FOTO;
document.getElementById('main-text').innerHTML = TEXTO.replace(/\n/g,'<br>');
const audioEl = document.getElementById('intro-audio');
audioEl.innerHTML = `<source src="${AUDIO}" type="audio/mpeg"/>
  <source src="${AUDIO.replace(/\.\w+$/,'.wav')}" type="audio/wav"/>
  <source src="${AUDIO.replace(/\.\w+$/,'.ogg')}" type="audio/ogg"/>`;

/* â”€â”€ Tiempos â”€â”€ */
const T_PARTY = TOTAL_MS * 0.10;
const T_ZOOM  = TOTAL_MS * 0.28;
const T_END   = TOTAL_MS * 0.82;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFETI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const cvs = document.getElementById('party-canvas');
const ctx  = cvs.getContext('2d');
let pieces=[], cAlpha=0, fading=false, spawnTimer=null, partyActive=false;
const COLS=['#FF6B8A','#FFD166','#06D6A0','#118AB2','#FF9F1C',
            '#E76F51','#F4A261','#A8DADC','#FF4D6D','#C77DFF',
            '#FFE0AC','#B5EAD7','#FFDAC1','#FF9AA2','#CAFFBF'];

function resizeCvs(){ cvs.width=window.innerWidth; cvs.height=window.innerHeight; }

function spawn(n){
  for(let i=0;i<n;i++){
    const s=Math.random();
    pieces.push({
      x:Math.random()*cvs.width, y:-10-Math.random()*180,
      w:5+Math.random()*9, h:3+Math.random()*5,
      col:COLS[Math.floor(Math.random()*COLS.length)],
      rot:Math.random()*Math.PI*2, rv:(Math.random()-.5)*.13,
      vx:(Math.random()-.5)*2.8,   vy:2.2+Math.random()*3.8,
      kind:s<.5?'rect':s<.8?'circle':'star'
    });
  }
}

function drawStar(r){
  ctx.beginPath();
  for(let i=0;i<5;i++){
    const a1=(i*4*Math.PI/5)-Math.PI/2, a2=((i*4+2)*Math.PI/5)-Math.PI/2;
    i===0?ctx.moveTo(r*Math.cos(a1),r*Math.sin(a1)):ctx.lineTo(r*Math.cos(a1),r*Math.sin(a1));
    ctx.lineTo(r*.4*Math.cos(a2),r*.4*Math.sin(a2));
  }
  ctx.closePath();
}

function drawPieces(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  pieces.forEach(p=>{
    ctx.save();
    ctx.globalAlpha=cAlpha; ctx.fillStyle=p.col;
    ctx.translate(p.x,p.y); ctx.rotate(p.rot);
    if(p.kind==='rect')         ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
    else if(p.kind==='circle') {ctx.beginPath();ctx.ellipse(0,0,p.w/2,p.h/2,0,0,Math.PI*2);ctx.fill();}
    else                       {drawStar(p.w/2);ctx.fill();}
    ctx.restore();
  });
}

function tickPieces(){
  pieces.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.rot+=p.rv; p.vx+=(Math.random()-.5)*.08; });
  if(fading) pieces=pieces.filter(p=>p.y<cvs.height+30);
}

function startParty(){
  partyActive=true; fading=false; cAlpha=0;
  cvs.classList.add('active'); spawn(150);
  spawnTimer=setInterval(()=>{ if(!fading) spawn(20); },260);
  const fi=setInterval(()=>{ cAlpha=Math.min(1,cAlpha+.08); if(cAlpha>=1) clearInterval(fi); },25);
}

function stopParty(){
  fading=true; clearInterval(spawnTimer);
  const fo=setInterval(()=>{
    cAlpha=Math.max(0,cAlpha-.04);
    if(cAlpha<=0){
      clearInterval(fo); partyActive=false;
      cvs.classList.remove('active'); pieces=[];
      ctx.clearRect(0,0,cvs.width,cvs.height);
    }
  },25);
}

function loop(){
  if(partyActive){ tickPieces(); drawPieces(); }
  requestAnimationFrame(loop);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TROMPETAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const HORNS=[
  {e:'ğŸ‰',x:'7vw',  y:'9vh', r:'-28deg',d:'0ms'  },
  {e:'ğŸŠ',x:'77vw', y:'8vh', r:'22deg', d:'100ms' },
  {e:'ğŸ‰',x:'4vw',  y:'62vh',r:'-18deg',d:'70ms'  },
  {e:'ğŸŠ',x:'83vw', y:'58vh',r:'32deg', d:'190ms' },
  {e:'ğŸˆ',x:'40vw', y:'4vh', r:'-8deg', d:'150ms' },
  {e:'ğŸˆ',x:'87vw', y:'28vh',r:'18deg', d:'50ms'  },
  {e:'ğŸˆ',x:'2vw',  y:'33vh',r:'-22deg',d:'230ms' },
  {e:'ğŸŠ',x:'60vw', y:'6vh', r:'12deg', d:'280ms' },
];
let hornEls=[];

function spawnHorns(){
  HORNS.forEach(h=>{
    const el=document.createElement('div');
    el.className='horn'; el.textContent=h.e;
    el.style.cssText=`left:${h.x};top:${h.y};--rot:${h.r};animation-delay:${h.d},calc(0.55s + ${h.d})`;
    document.body.appendChild(el); hornEls.push(el);
  });
}
function removeHorns(){
  hornEls.forEach(el=>{ el.classList.add('bye'); setTimeout(()=>el.remove(),700); });
  hornEls=[];
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let showStarted=false;
function startShow(){
  if(showStarted) return;
  showStarted=true;
  const tap=document.getElementById('tap-screen');
  tap.classList.add('hide');
  setTimeout(()=>tap.remove(),600);
  audioEl.currentTime=0;
  audioEl.play().catch(()=>{});
  document.getElementById('curtain-top').classList.add('open');
  document.getElementById('curtain-bot').classList.add('open');
  setTimeout(()=>{ startParty(); spawnHorns(); }, T_PARTY);
  setTimeout(()=>{ document.getElementById('scene').classList.add('zoom-in'); }, T_ZOOM);
  setTimeout(()=>{ stopParty(); removeHorns(); }, T_END);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAPTURA CON EXPANSIÃ“N AUTOMÃTICA
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   1. Agrega clase .capturing â†’ quita max-height y overflow
   2. Espera un frame para que el DOM se repinte
   3. html2canvas captura el cuadro expandido
   4. Quita la clase â†’ todo vuelve al estado normal
   El usuario no percibe ningÃºn cambio visual.
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function captureFrame(){
  const frameEl = document.getElementById('frame-outer');

  // Nombre en bold
  document.getElementById('name-display').textContent =
    document.getElementById('nameInput').value.trim();

  // Ocultar elementos que no van en la imagen
  const toHide = document.querySelectorAll('.field label, .btn-send, #status');
  toHide.forEach(el => el.style.visibility = 'hidden');

  // Expandir cuadro
  frameEl.classList.add('capturing');
  await new Promise(r => requestAnimationFrame(()=> requestAnimationFrame(r)));

  try {
    const dataUrl = await domtoimage.toPng(frameEl, {
      scale: 2,
      bgcolor: '#ffffff',
      filter: node => node.id !== 'party-canvas'
    });
    frameEl.classList.remove('capturing');
    toHide.forEach(el => el.style.visibility = '');
    return dataUrl.split(',')[1];
  } catch(err) {
    frameEl.classList.remove('capturing');
    toHide.forEach(el => el.style.visibility = '');
    throw err;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENVÃO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function submitForm(){
  const name = document.getElementById('nameInput').value.trim();
  const msg  = document.getElementById('msgInput').value.trim();
  const st   = document.getElementById('status');
  const btn  = document.getElementById('sendBtn');

  if(!name){ st.textContent='Por favor ingresÃ¡ tu nombre.';  return; }
  if(!msg) { st.textContent='Por favor escribÃ­ un mensaje.'; return; }

  btn.disabled=true;
  st.textContent='Enviando...';

  const img64 = await captureFrame().catch(e => { console.warn('Imagen omitida:', e); return null; });

  try{
    await fetch(APPS_SCRIPT_URL,{
      method:'POST', mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ name, message: msg, image: img64 })
    });
    st.textContent='Â¡Gracias por tu mensaje! ğŸ¤';
    document.getElementById('nameInput').value='';
    document.getElementById('msgInput').value='';
  }catch(err){
    st.textContent='Error al enviar. IntentÃ¡ de nuevo.';
    console.error(err);
  }finally{
    btn.disabled=false;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('load', ()=>{ resizeCvs(); loop(); });
window.addEventListener('resize', resizeCvs);
</script>
</body>
</html>
